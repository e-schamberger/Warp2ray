name: Windows Remote Server via PageKite
on: 
  workflow_dispatch:

jobs:
  remote-access:
    runs-on: windows-latest
    timeout-minutes: 360  # 6 ساعت
    steps:
    - name: Setup Remote Access
      run: |
        # تنظیمات اولیه
        $ErrorActionPreference = "Stop"
        
        # 1. ایجاد کاربر
        $username = "remoteadmin"
        $password = "SecurePass123!"
        $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
        
        try {
            New-LocalUser -Name $username -Password $securePassword -ErrorAction SilentlyContinue
            Add-LocalGroupMember -Group "Administrators" -Member $username
            Write-Host "User created successfully"
        } catch {
            Set-LocalUser -Name $username -Password $securePassword
            Write-Host "User password updated"
        }

        # 2. فعال کردن RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Write-Host "RDP enabled"

        # 3. تنظیمات PageKite
        Invoke-WebRequest -Uri "https://pagekite.net/pk/pagekite.py" -OutFile "pagekite.py"
        
        # فرمت صحیح دستور PageKite:
        $kite_name = "$env:PAGEKITE_USERNAME-rdp.pagekite.me"
        $command = "pagekite.py --clean --frontend=pagekite.net 3389 $kite_name:$env:PAGEKITE_SECRET"
        
        Write-Host "Executing: python $command"
        Start-Process python -ArgumentList $command -NoNewWindow -Wait
        
        # 4. نمایش اطلاعات اتصال
        Write-Host "`n=== CONNECTION DETAILS ==="
        Write-Host "RDP Address: $kite_name"
        Write-Host "Username: $username"
        Write-Host "Password: $password"
        Write-Host "=========================`n"
        
        # 5. نگه داشتن session فعال
        Write-Host "Server will remain active for 6 hours..."
        Start-Sleep -Seconds 21600
      env:
        PAGEKITE_USERNAME: ${{ secrets.PAGEKITE_USERNAME }}
        PAGEKITE_SECRET: ${{ secrets.PAGEKITE_SECRET }}
      shell: powershell
