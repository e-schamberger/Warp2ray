name: VNC via Cloudflare Tunnel
on: workflow_dispatch

jobs:
  deploy-vnc:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 Ø³Ø§Ø¹Øª Ø­Ø¯Ø§Ú©Ø«Ø± Ø§Ø¬Ø±Ø§

    steps:
    # Ù…Ø±Ø­Ù„Ù‡ 1: Ù†ØµØ¨ Ùˆ ØªÙ†Ø¸ÛŒÙ… VNC
    - name: Setup VNC Server
      run: |
        sudo apt update
        sudo apt install -y xfce4 tightvncserver
        
        # ØªÙ†Ø¸ÛŒÙ… Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø´Ù…Ø§
        mkdir -p ~/.vnc
        echo -e "1aq2sw@3de\n1aq2sw@3de\nn" | vncpasswd
        
        # Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ Ø³Ø±ÙˆÛŒØ³
        vncserver :1 -geometry 1280x800 -localhost

    # Ù…Ø±Ø­Ù„Ù‡ 2: ØªÙ†Ø¸ÛŒÙ… Cloudflare Tunnel
    - name: Configure Cloudflare
      env:
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        CLOUDFLARE_TUNNEL_ID: ${{ secrets.CLOUDFLARE_TUNNEL_ID }}
      run: |
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared
        
        # ÙØ§ÛŒÙ„ Ú©Ø§Ù†ÙÛŒÚ¯ Ø¨Ø§ Ø¯Ø§Ù…Ù†Ù‡ Ø´Ù…Ø§
        cat > config.yml <<EOL
        tunnel: $CLOUDFLARE_TUNNEL_ID
        credentials-file: ./tunnel.json
        ingress:
          - hostname: vnc.net2ray.dpdns.org
            service: tcp://localhost:5901
            originRequest:
              connectTimeout: 30s
          - service: http_status:404
        EOL
        
        # Ø§Ø¬Ø±Ø§ÛŒ ØªÙˆÙ†Ù„
        ./cloudflared tunnel --config config.yml run > tunnel.log 2>&1 &
        sleep 15

    # Ù…Ø±Ø­Ù„Ù‡ 3: Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
    - name: Show Connection Info
      run: |
        echo "===================================="
        echo "ğŸ–¥ï¸ VNC Connection Details:"
        echo ""
        echo "ğŸ”— Address: vnc.net2ray.dpdns.org:5901"
        echo "ğŸ”‘ Password: 1aq2sw@3de"
        echo ""
        echo "âš ï¸ Note: Auto-terminates after 6 hours"
        echo "===================================="

    # Ù…Ø±Ø­Ù„Ù‡ 4: Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø§ØªØµØ§Ù„
    - name: Keep Alive
      run: |
        while true; do
          echo "$(date): Connection active"
          sleep 60
        done
