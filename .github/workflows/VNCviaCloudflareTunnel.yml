name: VNC via Cloudflare Tunnel
on: workflow_dispatch

jobs:
  deploy-vnc:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    # Ù…Ø±Ø­Ù„Ù‡ 1: Ù†ØµØ¨ Ùˆ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ VNC
    - name: Setup VNC Server
      run: |
        sudo apt update
        sudo apt install -y xfce4 tightvncserver
        mkdir -p ~/.vnc
        echo -e "1aq2sw@3de\n1aq2sw@3de\nn" | vncpasswd
        vncserver :1 -geometry 1280x800 -localhost

    # Ù…Ø±Ø­Ù„Ù‡ 2: ØªÙ†Ø¸ÛŒÙ… Cloudflare Tunnel (Ù†Ø³Ø®Ù‡ Ù¾Ø§ÛŒØ¯Ø§Ø±)
    - name: Configure Cloudflare Tunnel
      env:
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        CLOUDFLARE_TUNNEL_ID: ${{ secrets.CLOUDFLARE_TUNNEL_ID }}
      run: |
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ù†ØµØ¨ cloudflared
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
        chmod +x cloudflared
        sudo mv cloudflared /usr/local/bin/
        
        # Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
        cloudflared tunnel login
        
        # Ø³Ø§Ø®Øª ØªÙˆÙ†Ù„ (Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§ Ù†Ø³Ø§Ø®ØªÙ‡â€ŒØ§ÛŒØ¯)
        cloudflared tunnel create $CLOUDFLARE_TUNNEL_ID
        
        # ØªÙ†Ø¸ÛŒÙ… DNS
        cloudflared tunnel route dns $CLOUDFLARE_TUNNEL_ID vnc.net2ray.dpdns.org
        
        # Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ Ú©Ø§Ù†ÙÛŒÚ¯
        cat > config.yml <<EOL
        tunnel: $CLOUDFLARE_TUNNEL_ID
        credentials-file: ./tunnel.json
        ingress:
          - hostname: vnc.net2ray.dpdns.org
            service: tcp://localhost:5901
            originRequest:
              connectTimeout: 30s
              keepAlive: 30s
          - service: http_status:404
        EOL
        
        # Ø§Ø¬Ø±Ø§ÛŒ ØªÙˆÙ†Ù„ Ø¯Ø± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø¨Ø§ nohup
        nohup cloudflared tunnel --config config.yml run > tunnel.log 2>&1 &
        
        # Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ
        sleep 30
        
        # Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ
        cat tunnel.log
        echo "ØªÙˆÙ†Ù„ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³Øª..."

    # Ù…Ø±Ø­Ù„Ù‡ 3: Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯
    - name: Monitor Connection
      run: |
        echo "âœ… VNC Ready!"
        echo "ğŸ”— Ø¢Ø¯Ø±Ø³: vnc.net2ray.dpdns.org:5901"
        echo "ğŸ”‘ Ø±Ù…Ø²: 1aq2sw@3de"
        echo "ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ø§ØªØµØ§Ù„..."
        
        # Ú†Ú© Ù…Ø¯Ø§ÙˆÙ… ÙˆØ¶Ø¹ÛŒØª
        while true; do
          if ! pgrep -x "cloudflared" >/dev/null; then
            echo "âŒ ØªÙˆÙ†Ù„ Ù‚Ø·Ø¹ Ø´Ø¯Ù‡! ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯..."
            nohup cloudflared tunnel --config config.yml run > tunnel.log 2>&1 &
          fi
          
          if ! pgrep -x "Xtightvnc" >/dev/null; then
            echo "âŒ VNC Ù‚Ø·Ø¹ Ø´Ø¯Ù‡! Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯..."
            vncserver :1 -geometry 1280x800 -localhost
          fi
          
          sleep 30
        done
