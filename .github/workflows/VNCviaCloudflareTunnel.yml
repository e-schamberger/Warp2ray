name: VNC via Cloudflare Tunnel
on: workflow_dispatch

jobs:
  deploy-vnc:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    # ŸÖÿ±ÿ≠ŸÑŸá 1: ŸÜÿµÿ® Ÿà ÿ™ŸÜÿ∏€åŸÖ VNC
    - name: Setup VNC Server
      run: |
        sudo apt update
        sudo apt install -y xfce4 tightvncserver net-tools dnsutils
        mkdir -p ~/.vnc
        echo -e "1aq2sw@3de\n1aq2sw@3de\nn" | vncpasswd
        vncserver :1 -geometry 1280x800 -localhost
        echo "VNC_PASSWORD=1aq2sw@3de" >> $GITHUB_ENV

    # ŸÖÿ±ÿ≠ŸÑŸá 2: ÿ™ŸÜÿ∏€åŸÖ DNS Ÿà ÿ¥ÿ®⁄©Ÿá
    - name: Configure Network
      run: |
        # ÿ™ŸÜÿ∏€åŸÖ DNS ÿ≥ÿ±Ÿàÿ±Ÿáÿß€å ŸÖÿπÿ™ÿ®ÿ±
        echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf
        echo "nameserver 8.8.8.8" | sudo tee -a /etc/resolv.conf
        
        # ÿ™ÿ≥ÿ™ DNS
        nslookup vnc.net2ray.dpdns.org
        dig vnc.net2ray.dpdns.org

    # ŸÖÿ±ÿ≠ŸÑŸá 3: ÿ±ÿßŸá‚ÄåÿßŸÜÿØÿßÿ≤€å ÿ™ŸàŸÜŸÑ
    - name: Start Cloudflare Tunnel
      env:
        CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      run: |
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O ./cloudflared
        chmod +x ./cloudflared
        
        # ÿ≥ÿßÿÆÿ™ ŸÅÿß€åŸÑ ⁄©ÿßŸÜŸÅ€å⁄Ø ÿ®ÿß ÿ™ŸÜÿ∏€åŸÖÿßÿ™ DNS
        cat > config.yml <<EOL
        tunnel: github-vnc-tunnel
        credentials-file: ./tunnel.json
        dns:
          enabled: true
          upstream:
            - "https://1.1.1.1/dns-query"
            - "https://8.8.8.8/dns-query"
        ingress:
          - hostname: vnc.net2ray.dpdns.org
            service: tcp://localhost:5901
            originRequest:
              connectTimeout: 30s
              noTLSVerify: true
          - service: http_status:404
        EOL
        
        # ÿßÿ¨ÿ±ÿß€å ÿ™ŸàŸÜŸÑ ÿ®ÿß ŸÑÿß⁄Ø ⁄©ÿßŸÖŸÑ
        nohup ./cloudflared tunnel --config config.yml run > tunnel.log 2>&1 &
        sleep 20
        
        # ÿ®ÿ±ÿ±ÿ≥€å Ÿàÿ∂ÿπ€åÿ™
        ./cloudflared tunnel info github-vnc-tunnel
        cat tunnel.log

    # ŸÖÿ±ÿ≠ŸÑŸá 4: ŸÖÿßŸÜ€åÿ™Ÿàÿ±€åŸÜ⁄Ø
    - name: Monitor Connection
      run: |
        echo "‚úÖ VNC Ready at vnc.net2ray.dpdns.org:5901"
        echo "üîë Password: ${{ env.VNC_PASSWORD }}"
        
        while true; do
          # ÿ™ÿ≥ÿ™ ÿßÿ™ÿµÿßŸÑ Ÿáÿ± 1 ÿØŸÇ€åŸÇŸá
          if ! nc -zv localhost 5901 &>/dev/null; then
            echo "‚ùå VNC Connection Lost! Restarting..."
            vncserver :1 -geometry 1280x800 -localhost
          fi
          
          sleep 60
          echo "[$(date)] Connection check passed"
        done
