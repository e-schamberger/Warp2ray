name: VNC via Cloudflare Tunnel
on: workflow_dispatch

jobs:
  deploy-vnc:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    # Ù…Ø±Ø­Ù„Ù‡ 1: Ù†ØµØ¨ VNC
    - name: Install VNC Server
      run: |
        sudo apt update
        sudo apt install -y xfce4 tightvncserver
        mkdir -p ~/.vnc
        echo -e "1aq2sw@3de\n1aq2sw@3de\nn" | vncpasswd
        vncserver :1 -geometry 1280x800 -localhost

    # Ù…Ø±Ø­Ù„Ù‡ 2: Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ ØªÙ†Ø¸ÛŒÙ… cloudflared (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡)
    - name: Setup Cloudflared
      run: |
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ø§ Ù†Ø§Ù… Ù…Ø´Ø®Øµ Ùˆ Ù…Ø³ÛŒØ± Ú©Ø§Ù…Ù„
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O /tmp/cloudflared
        # ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬ÙˆØ²Ù‡Ø§
        chmod +x /tmp/cloudflared
        # Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ Ù…Ø³ÛŒØ± Ø§Ø¬Ø±Ø§ÛŒÛŒ
        sudo mv /tmp/cloudflared /usr/local/bin/
        # ØªØ³Øª Ù†ØµØ¨
        cloudflared --version

    # Ù…Ø±Ø­Ù„Ù‡ 3: Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
    - name: Authenticate
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      run: |
        mkdir -p ~/.cloudflared
        cloudflared tunnel login
        cp ~/.cloudflared/cert.pem ./

    # Ù…Ø±Ø­Ù„Ù‡ 4: Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ ØªÙˆÙ†Ù„
    - name: Start Tunnel
      env:
        CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      run: |
        cat > config.yml <<EOL
        tunnel: github-vnc-tunnel
        credentials-file: ./tunnel.json
        originCert: ./cert.pem
        ingress:
          - hostname: vnc.net2ray.dpdns.org
            service: tcp://localhost:5901
            originRequest:
              connectTimeout: 30s
          - service: http_status:404
        EOL
        
        nohup cloudflared tunnel --config config.yml run > tunnel.log 2>&1 &
        sleep 20
        cat tunnel.log

    # Ù…Ø±Ø­Ù„Ù‡ 5: Ù†Ú¯Ù‡Ø¯Ø§Ø´Øª Ø§ØªØµØ§Ù„
    - name: Keep Alive
      run: |
        echo "âœ… VNC Ready at vnc.net2ray.dpdns.org:5901"
        echo "ðŸ”‘ Password: 1aq2sw@3de"
        while true; do
          sleep 60
          echo "[$(date)] Connection active"
        done
