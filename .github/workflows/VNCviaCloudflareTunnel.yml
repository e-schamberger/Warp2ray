name: VNC via Cloudflare Tunnel
on: workflow_dispatch

jobs:
  deploy-vnc:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 ساعت

    steps:
    # مرحله 1: نصب و راه‌اندازی VNC
    - name: Install and Setup VNC
      run: |
        sudo apt update
        sudo apt install -y xfce4 tightvncserver
        mkdir -p ~/.vnc
        echo -e "1aq2sw@3de\n1aq2sw@3de\nn" | vncpasswd
        vncserver :1 -geometry 1280x800 -localhost

    # مرحله 2: تنظیم Cloudflare Tunnel
    - name: Configure Cloudflare Tunnel
      env:
        CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      run: |
        # دانلود cloudflared
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared
        
        # ساخت فایل کانفیگ
        cat > config.yml <<EOL
        tunnel: github-vnc-tunnel
        credentials-file: ./tunnel.json
        ingress:
          - hostname: vnc.net2ray.dpdns.org
            service: tcp://localhost:5901
            originRequest:
              connectTimeout: 30s
          - service: http_status:404
        EOL
        
        # اجرای تونل
        nohup ./cloudflared tunnel --config config.yml run > tunnel.log 2>&1 &
        sleep 15  # منتظر بمانید تا تونل راه‌اندازی شود

    # مرحله 3: نگه‌داشت اتصال
    - name: Keep Connection Alive
      run: |
        echo "✅ VNC Ready for Connection!"
        echo "🌐 Address: vnc.net2ray.dpdns.org:5901"
        echo "🔑 Password: 1aq2sw@3de"
        echo "⏳ This session will remain active for 6 hours..."
        
        # حلقه بی‌نهایت برای فعال نگه‌داشتن جاب
        while true; do
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] VNC session is active"
          sleep 60
        done
