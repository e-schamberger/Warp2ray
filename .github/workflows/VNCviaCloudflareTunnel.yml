name: VNC via Cloudflare
on: workflow_dispatch

jobs:
  deploy-vnc:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    # Ù…Ø±Ø­Ù„Ù‡ 1: ØªÙ†Ø¸ÛŒÙ… DNS Ùˆ Ø´Ø¨Ú©Ù‡
    - name: Configure DNS
      run: |
        # ØªÙ†Ø¸ÛŒÙ… DNS Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ù…Ø¹ØªØ¨Ø±
        echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf
        echo "nameserver 8.8.8.8" | sudo tee -a /etc/resolv.conf
        sudo systemctl restart systemd-resolved
        
        # Ù†ØµØ¨ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ø´Ø¨Ú©Ù‡
        sudo apt update
        sudo apt install -y dnsutils net-tools

    # Ù…Ø±Ø­Ù„Ù‡ 2: Ù†ØµØ¨ VNC
    - name: Install VNC
      run: |
        sudo apt install -y xfce4 tightvncserver
        mkdir -p ~/.vnc
        echo -e "1aq2sw@3de\n1aq2sw@3de\nn" | vncpasswd
        vncserver :1 -geometry 1280x800 -localhost

    # Ù…Ø±Ø­Ù„Ù‡ 3: Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªÙˆÙ†Ù„ (Ù†Ø³Ø®Ù‡ Ù¾Ø§ÛŒØ¯Ø§Ø±)
    - name: Start Cloudflare Tunnel
      env:
        CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      run: |
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ø§ Ù…Ø³ÛŒØ± Ù…Ø·Ù„Ù‚
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O /usr/local/bin/cloudflared
        chmod +x /usr/local/bin/cloudflared
        
        # Ø³Ø§Ø®Øª Ú©Ø§Ù†ÙÛŒÚ¯ Ø¨Ø§ DNS Ø¯Ø§Ø®Ù„ÛŒ
        cat > config.yml <<EOL
        tunnel: github-vnc
        credentials-file: ./tunnel.json
        dns:
          enabled: true
          upstream:
            - "https://1.1.1.1/dns-query"
            - "https://8.8.8.8/dns-query"
        ingress:
          - hostname: vnc.net2ray.dpdns.org
            service: tcp://localhost:5901
            originRequest:
              connectTimeout: 30s
              noTLSVerify: true
          - service: http_status:404
        EOL
        
        # Ø§Ø¬Ø±Ø§ Ø¨Ø§ Ù„Ø§Ú¯ Ú©Ø§Ù…Ù„
        nohup cloudflared tunnel --config config.yml run > tunnel.log 2>&1 &
        sleep 30
        
        # ØªØ³Øª Ø§ØªØµØ§Ù„
        nslookup vnc.net2ray.dpdns.org
        nc -zv vnc.net2ray.dpdns.org 5901

    # Ù…Ø±Ø­Ù„Ù‡ 4: Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯
    - name: Monitor Connection
      run: |
        echo "âœ… VNC Ready!"
        echo "ðŸŒ Address: vnc.net2ray.dpdns.org:5901"
        echo "ðŸ”‘ Password: 1aq2sw@3de"
        
        while true; do
          if ! nc -zv localhost 5901 &>/dev/null; then
            echo "ðŸ”„ Restarting VNC..."
            vncserver :1 -geometry 1280x800 -localhost
          fi
          sleep 60
        done
