name: Windows RDP Manual
on: 
  workflow_dispatch: # فقط اجرای دستی
permissions:
  contents: read

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: 360 # 6 ساعت
    
    steps:
    - name: Download cloudflared
      run: |
        iwr -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"

    - name: Enable RDP
      run: |
        reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes
        $pass = ConvertTo-SecureString "YourPassword123!" -AsPlainText -Force
        Set-LocalUser -Name "runner" -Password $pass

    - name: Configure Tunnel
      env:
        TUNNEL_JSON: ${{ secrets.CLOUDFLARE_TUNNEL_JSON }}
      run: |
        md "$env:USERPROFILE\.cloudflared" -Force
        [System.IO.File]::WriteAllText("$env:USERPROFILE\.cloudflared\credentials.json", $env:TUNNEL_JSON)
        @"
tunnel: ${{ secrets.CLOUDFLARE_TUNNEL_ID }}
credentials-file: $env:USERPROFILE\.cloudflared\credentials.json
ingress:
  - hostname: win.net2ray.dpdns.org
    service: rdp://localhost:3389
  - service: http_status:404
"@ | Out-File "$env:USERPROFILE\.cloudflared\config.yml"

    - name: Run Tunnel
      run: Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel run" -WindowStyle Hidden
