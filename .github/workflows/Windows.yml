name: VNC via Cloudflare (Final Fix)
on: workflow_dispatch

jobs:
  deploy-vnc:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    # مرحله 1: تنظیمات شبکه
    - name: Network Setup
      run: |
        sudo sysctl -w net.ipv6.conf.all.disable_ipv6=1
        sudo sysctl -w net.ipv6.conf.default.disable_ipv6=1
        echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf
        echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf

    # مرحله 2: نصب VNC
    - name: Install VNC
      run: |
        sudo apt update
        sudo apt install -y xfce4 tightvncserver
        mkdir -p ~/.vnc
        echo -e "1aq2sw@3de\n1aq2sw@3de\nn" | vncpasswd
        vncserver :1 -geometry 1280x800 -localhost

    # مرحله 3: راه‌اندازی تونل (نسخه نهایی)
    - name: Start Cloudflare Tunnel
      env:
        CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      run: |
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
        chmod +x cloudflared
        
        # ساخت کانفیگ با تنظیمات ویژه
        cat > config.yml <<EOL
        tunnel: github-vnc
        credentials-file: ./tunnel.json
        protocol: http2
        warp-routing:
          enabled: true
        originRequest:
          connectTimeout: 30s
          noHappyEyeballs: true
          http2Origin: true
          originServerName: vnc.net2ray.dpdns.org
        ingress:
          - hostname: vnc.net2ray.dpdns.org
            service: tcp://localhost:5901
          - service: http_status:404
        EOL
        
        # اجرا با لاگ کامل
        nohup ./cloudflared tunnel --config config.yml run > tunnel.log 2>&1 &
        sleep 30
        
        # تست اتصال با روش جایگزین
        IP=$(getent hosts vnc.net2ray.dpdns.org | awk '{ print $1 }' | head -n1)
        echo "Resolved IP: $IP"
        nc -zv $IP 5901 || true

    # مرحله 4: مانیتورینگ
    - name: Monitor Connection
      run: |
        echo "✅ VNC Service is Running"
        echo "🌐 Connect using:"
        echo "Address: vnc.net2ray.dpdns.org:5901"
        echo "Password: 1aq2sw@3de"
        
        while true; do
          if ! pgrep -x "Xtightvnc" >/dev/null; then
            echo "🔄 Restarting VNC Server..."
            vncserver :1 -geometry 1280x800 -localhost
          fi
          sleep 60
        done
