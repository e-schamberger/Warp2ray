name: Windows RDP Manual
on: workflow_dispatch

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    - name: Download cloudflared
      run: |
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"

    - name: Configure Tunnel
      env:
        TUNNEL_JSON: ${{ secrets.CLOUDFLARE_TUNNEL_JSON }}
        TUNNEL_ID: ${{ secrets.CLOUDFLARE_TUNNEL_ID }}
      run: |
        New-Item -ItemType Directory -Path "$env:USERPROFILE\.cloudflared" -Force
        [System.IO.File]::WriteAllText("$env:USERPROFILE\.cloudflared\credentials.json", $env:TUNNEL_JSON)
        @"
tunnel: $env:TUNNEL_ID
credentials-file: $env:USERPROFILE\.cloudflared\credentials.json
ingress:
  - hostname: win.net2ray.dpdns.org
    service: rdp://localhost:3389
  - service: http_status:404
"@ | Out-File "$env:USERPROFILE\.cloudflared\config.yml"

    - name: Run Tunnel
      run: Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel run" -WindowStyle Hidden
