name: ğŸš€ Windows RDP (Manual Run)

on:
  workflow_dispatch: # ÙÙ‚Ø· Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 360 # 6 Ø³Ø§Ø¹Øª

    steps:
    - name: ğŸ”» Checkout repository
      uses: actions/checkout@v4

    - name: â¬‡ï¸ Download cloudflared
      run: |
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"

    - name: ğŸ› ï¸ Configure RDP Settings
      run: |
        # ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # ØªÙ†Ø¸ÛŒÙ… Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± runner
        $password = ConvertTo-SecureString "YourStrongPassword123!" -AsPlainText -Force
        Set-LocalUser -Name "runner" -Password $password
        Write-Output "âœ”ï¸ RDP configured successfully"

    - name: ğŸ” Setup Cloudflare Tunnel
      env:
        TUNNEL_CREDENTIALS: ${{ secrets.CLOUDFLARE_TUNNEL_CREDENTIALS }}
        TUNNEL_ID: ${{ secrets.CLOUDFLARE_TUNNEL_ID }}
      run: |
        # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÙˆØ´Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
        New-Item -ItemType Directory -Path "$env:USERPROFILE\.cloudflared" -Force
        
        # Ø°Ø®ÛŒØ±Ù‡ credentials
        [IO.File]::WriteAllText("$env:USERPROFILE\.cloudflared\credentials.json", $env:TUNNEL_CREDENTIALS)
        
        # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ config
        $config = @"
tunnel: $env:TUNNEL_ID
credentials-file: $env:USERPROFILE\.cloudflared\credentials.json
ingress:
  - hostname: win.net2ray.dpdns.org
    service: rdp://localhost:3389
  - service: http_status:404
"@
        [IO.File]::WriteAllText("$env:USERPROFILE\.cloudflared\config.yml", $config)
        Write-Output "âœ”ï¸ Cloudflare Tunnel configured"

    - name: ğŸš€ Run Cloudflare Tunnel
      run: Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel run" -WindowStyle Hidden
      continue-on-error: true

    - name: â„¹ï¸ Display Connection Info
      run: |
        Write-Output "âœ… RDP Server is ready!"
        Write-Output "â–¸ Connect to: win.net2ray.dpdns.org"
        Write-Output "â–¸ Username: runner"
        Write-Output "â–¸ Password: YourStrongPassword123!"
        Write-Output "â–¸ This session will auto-terminate after 6 hours"
